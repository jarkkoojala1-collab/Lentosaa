<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PPG Lentokeli</title>

<style>
body{
    font-family:system-ui;
    background:#0b1220;
    color:white;
    margin:0;
    padding:15px;
}
h1{margin-top:0}

.card{
    background:#111a2e;
    padding:12px;
    border-radius:10px;
    margin-bottom:12px;
}

.hour{
    display:flex;
    justify-content:space-between;
    padding:6px;
    border-bottom:1px solid #223;
}

.good{color:#6CFF8F}
.medium{color:#FFD166}
.bad{color:#FF6B6B}
</style>
</head>
<body>

<h1>PPG Lentokeli</h1>

<div class="card">
<input id="placeInput" placeholder="Hae lentopaikka…">
<button onclick="haePaikka(document.getElementById('placeInput').value)">Hae</button>
<div id="locationName"></div>
</div>

<div class="card">
<div id="status">Haetaan sijaintia…</div>
<div id="slope"></div>
</div>

<div id="hours"></div>

<script>
/* ==========================
   PAIKAN HAKU
   ========================== */
async function haePaikka(nimi){

    const url=`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(nimi)}&count=1&language=fi&format=json`;

    const r=await fetch(url);
    const data=await r.json();

    if(!data.results || !data.results.length){
        alert("Paikkaa ei löytynyt");
        return;
    }

    const p=data.results[0];
    document.getElementById("locationName").textContent=p.name+", "+p.country;

    haeSaa(p.latitude,p.longitude);
}

/* ==========================
   TURBULENSSI
   ========================== */
function laskePPGTurbulenssi(wind, gust, tempNow, tempPrev, hour){

    let shear = gust - wind;
    let tempTrend = tempNow - tempPrev;

    let stability = 0;
    if(hour<=8 || hour>=20) stability-=2.5;
    if(hour>=10 && hour<=17 && tempTrend>0) stability+=tempTrend*1.2;

    return wind*0.55 + shear*1.35 + Math.abs(tempTrend)*0.9 + stability;
}

function ppgStatus(i){
    if(i<8) return ["Hyvä","good"];
    if(i<14) return ["Rajalla","medium"];
    return ["Huono","bad"];
}

/* ==========================
   RINNELENTO
   ========================== */
function arvioiRinne(windDir, windSpeed, slopeDir){

    let diff=Math.abs(windDir-slopeDir);
    if(diff>180) diff=360-diff;

    if(windSpeed<2) return "Ei nousevaa";
    if(diff<25 && windSpeed>=4) return "Erinomainen";
    if(diff<45 && windSpeed>=3) return "Toimiva";
    if(diff<80) return "Heikko";
    return "Takatuuli";
}

/* ==========================
   HAE SÄÄ
   ========================== */
async function haeSaa(lat,lon){

document.getElementById("status").textContent="Haetaan säätä…";

const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,windspeed_10m,windgusts_10m,winddirection_10m&forecast_days=1`;

const r=await fetch(url);
const data=await r.json();

renderHours(data.hourly);
}

/* ==========================
   RENDER
   ========================== */
function renderHours(h){

const container=document.getElementById("hours");
container.innerHTML="";

let firstIndex=null;

for(let i=0;i<24;i++){

let wind=h.windspeed_10m[i];
let gust=h.windgusts_10m[i];
let temp=h.temperature_2m[i];
let dir=h.winddirection_10m[i];

let prev=i>0?h.temperature_2m[i-1]:temp;
let hour=new Date(h.time[i]).getHours();

let index=laskePPGTurbulenssi(wind,gust,temp,prev,hour);
let [txt,cls]=ppgStatus(index);

if(firstIndex===null) firstIndex=index;

let row=document.createElement("div");
row.className="hour";

let slope=arvioiRinne(dir,wind,180);

row.innerHTML=`
<div>${hour}:00</div>
<div>${wind.toFixed(1)} m/s</div>
<div class="${cls}">${txt}</div>
<div>${slope}</div>
`;

container.appendChild(row);

if(i===0){
document.getElementById("status").innerHTML=`Tämän hetken lentokeli: <b class="${cls}">${txt}</b>`;
document.getElementById("slope").textContent="Rinne (etelä 180°): "+slope;
}
}
}

/* ==========================
   GPS
   ========================== */
function start(){
if(!navigator.geolocation){
document.getElementById("status").textContent="Sijainti ei tuettu";
return;
}

navigator.geolocation.getCurrentPosition(
pos=>haeSaa(pos.coords.latitude,pos.coords.longitude),
()=>document.getElementById("status").textContent="Sijaintia ei saatu"
);
}

start();
</script>

</body>
</html>