<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LentoS√§√§ Pro - MultiModel</title>

    <style>
        :root {
            --bg: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --accent: #38bdf8;
            --success: #4ade80;
            --warning: #fbbf24;
            --danger: #f87171;
            --text: #f1f5f9;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: radial-gradient(circle at top right, #1e293b, #0f172a);
            color: var(--text);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container { max-width: 500px; margin: auto; }

        h1 { font-weight: 800; font-size: 1.8rem; letter-spacing: -1px; margin-bottom: 5px; text-align: center; }
        .subtitle { opacity: 0.6; font-size: 0.8rem; margin-bottom: 25px; text-align: center; text-transform: uppercase; letter-spacing: 1px; }

        .search-group {
            display: flex;
            background: var(--card-bg);
            padding: 5px;
            border-radius: 16px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 25px;
        }

        input { flex: 1; background: transparent; border: none; color: white; padding: 12px 15px; font-size: 16px; outline: none; }
        button { background: var(--accent); color: #0f172a; border: none; padding: 12px 20px; border-radius: 12px; font-weight: 700; cursor: pointer; }

        .section {
            background: var(--card-bg);
            border-radius: 24px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.05);
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; margin-bottom: 8px; }

        .wind-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .wind-row:last-child { border: none; }

        .wind-arrow { font-size: 1.4rem; color: var(--accent); display: inline-block; transition: transform 0.5s; }

        .scroll-x { display: flex; overflow-x: auto; gap: 12px; padding: 10px 0; scrollbar-width: none; }
        .scroll-x::-webkit-scrollbar { display: none; }

        .hour-card { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 18px; min-width: 85px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }

        .model-info { font-size: 0.7rem; opacity: 0.5; margin-top: 10px; font-style: italic; }
    </style>
</head>

<body>
    <div class="container">
        <h1>LentoS√§√§ Pro</h1>
        <p class="subtitle">ECMWF + GFS + ICON Keskiarvo</p>
        
        <div class="search-group">
            <input id="city" type="text" placeholder="Hae kaupunkia..." onkeypress="if(event.key === 'Enter') haeSaa()">
            <button onclick="haeSaa()">Hae</button>
        </div>

        <h2 id="otsikko" style="font-size: 1.1rem; margin-left: 5px; opacity: 0.8;">Haetaan sijaintia...</h2>

        <div id="mainContent" style="display:none;">
            <div class="section">
                <div id="rinneStatus"></div>
                <div id="ppgStatus"></div>
            </div>

            <div class="section">
                <h3 style="margin:0 0 10px 0; font-size: 0.9rem; opacity: 0.7; text-transform: uppercase;">Korkeustuulet (Keskiarvo)</h3>
                <div class="wind-row">
                    <span>Maanpinta</span>
                    <span id="v0" style="font-weight:700;">--</span>
                    <div id="d0" class="wind-arrow">‚Üë</div>
                </div>
                <div class="wind-row">
                    <span>1500 m (850hPa)</span>
                    <span id="v1500" style="font-weight:700;">--</span>
                    <div id="d1500" class="wind-arrow">‚Üë</div>
                </div>
                <div class="wind-row">
                    <span>2000 m (800hPa)</span>
                    <span id="v2000" style="font-weight:700;">--</span>
                    <div id="d2000" class="wind-arrow">‚Üë</div>
                </div>
                <p class="model-info">Laskettu 3 ennustemallin keskiarvona.</p>
            </div>

            <h3 style="font-size: 0.9rem; opacity: 0.7; margin: 20px 0 10px 5px; text-transform: uppercase;">12h Yhdistelm√§ennuste</h3>
            <div id="tunnit" class="scroll-x"></div>
        </div>
    </div>

    <script>
        const getEl = id => document.getElementById(id);

        window.onload = () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => haeSaa(pos.coords.latitude, pos.coords.longitude),
                    () => { getEl("otsikko").innerText = "Sy√∂t√§ paikka yll√§"; }
                );
            }
        };

        async function haeSaa(lat = null, lon = null) {
            let p = { latitude: lat, longitude: lon, name: "Nykyinen sijainti" };

            if (!lat) {
                const k = getEl("city").value;
                if (!k) return;
                const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${k}&count=1&language=fi`);
                const geoData = await geoRes.json();
                p = geoData.results?.[0];
                if (!p) return alert("Paikkaa ei l√∂ytynyt");
            }

            getEl("otsikko").innerText = `üìç ${p.name}`;
            getEl("mainContent").style.display = "block";

            // Haetaan data kolmesta eri mallista: ECMWF, GFS, ICON
            const models = "ecmwf_ifs04,gfs_seamless,icon_seamless";
            const fields = "temperature_2m,windspeed_10m,winddirection_10m,windspeed_850hPa,winddirection_850hPa,windspeed_800hPa,winddirection_800hPa";
            
            try {
                const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${p.latitude}&longitude=${p.longitude}&hourly=${fields}&models=${models}&timezone=auto`);
                const d = await weatherRes.json();
                
                // Lasketaan keskiarvot
                const combined = laskeKeskiarvot(d.hourly);
                
                // Nykyhetken indeksi (haetaan l√§hin tunti)
                const nyt = new Date().toISOString().slice(0, 13) + ":00";
                const s = d.hourly.time.indexOf(nyt) || 0;

                paivitaNakyma(combined, s);
            } catch (e) { alert("Virhe s√§√§malleja laskiessa"); }
        }

        function laskeKeskiarvot(h) {
            const combined = { time: h.time, temperature_2m: [], windspeed_10m: [], winddirection_10m: [], windspeed_850hPa: [], winddirection_850hPa: [], windspeed_800hPa: [], winddirection_800hPa: [] };
            
            const malleja = ["_ecmwf_ifs04", "_gfs_seamless", "_icon_seamless"];

            for (let t = 0; t < h.time.length; t++) {
                combined.temperature_2m.push(avg(t, h, "temperature_2m", malleja));
                combined.windspeed_10m.push(avg(t, h, "windspeed_10m", malleja));
                combined.windspeed_850hPa.push(avg(t, h, "windspeed_850hPa", malleja));
                combined.windspeed_800hPa.push(avg(t, h, "windspeed_800hPa", malleja));
                
                // Suunnat keskiarvostetaan vektorina
                combined.winddirection_10m.push(avgDir(t, h, "winddirection_10m", malleja));
                combined.winddirection_850hPa.push(avgDir(t, h, "winddirection_850hPa", malleja));
                combined.winddirection_800hPa.push(avgDir(t, h, "winddirection_800hPa", malleja));
            }
            return combined;
        }

        function avg(t, h, key, malleja) {
            let sum = 0, count = 0;
            malleja.forEach(m => { if(h[key+m]) { sum += h[key+m][t]; count++; } });
            return count ? (sum / count).toFixed(1) : 0;
        }

        function avgDir(t, h, key, malleja) {
            let sinSum = 0, cosSum = 0, count = 0;
            malleja.forEach(m => {
                if(h[key+m]) {
                    let rad = h[key+m][t] * Math.PI / 180;
                    sinSum += Math.sin(rad); cosSum += Math.cos(rad); count++;
                }
            });
            let avgRad = Math.atan2(sinSum / count, cosSum / count);
            let deg = avgRad * 180 / Math.PI;
            return (deg < 0 ? deg + 360 : deg).toFixed(0);
        }

        function paivitaNakyma(h, i) {
            getEl("v0").innerText = h.windspeed_10m[i] + " m/s";
            getEl("d0").style.transform = `rotate(${h.winddirection_10m[i]}deg)`;
            getEl("v1500").innerText = h.windspeed_850hPa[i] + " m/s";
            getEl("d1500").style.transform = `rotate(${h.winddirection_850hPa[i]}deg)`;
            getEl("v2000").innerText = h.windspeed_800hPa[i] + " m/s";
            getEl("d2000").style.transform = `rotate(${h.winddirection_800hPa[i]}deg)`;

            renderAnalyysi("rinneStatus", "ü™Ç Rinne", h.windspeed_10m[i], 4, 10, 12);
            renderAnalyysi("ppgStatus", "üõ©Ô∏è PPG", h.windspeed_10m[i], 0, 4, 6);

            getEl("tunnit").innerHTML = "";
            for (let t = i; t < i + 12; t++) {
                getEl("tunnit").innerHTML += `
                    <div class="hour-card">
                        <div style="font-size:0.7rem; opacity:0.5">${h.time[t].slice(11,16)}</div>
                        <div style="font-weight:700; margin:5px 0">${h.temperature_2m[t]}¬∞</div>
                        <div style="color:var(--accent); font-size:0.9rem">${h.windspeed_10m[t]}m/s</div>
                        <div class="wind-arrow" style="transform:rotate(${h.winddirection_10m[t]}deg); font-size:1rem">‚Üë</div>
                    </div>`;
            }
        }

        function renderAnalyysi(id, title, w, min, opt, max) {
            let res = { label: "Huono", color: "var(--danger)", desc: "Mallit ennustavat liikaa tuulta." };
            if (w >= min && w <= opt) res = { label: "Hyv√§", color: "var(--success)", desc: "Mallien keskiarvo n√§ytt√§√§ hyv√§lt√§." };
            else if (w <= max) res = { label: "Rajakelpo", color: "var(--warning)", desc: "Malleissa on hajontaa tai keli on tiukka." };

            getEl(id).innerHTML = `
                <div style="margin-bottom:15px">
                    <span class="status-badge" style="background:${res.color}">${res.label}</span>
                    <div style="font-weight:700; font-size:1.1rem">${title}</div>
                    <div style="font-size:0.8rem; opacity:0.6">${res.desc}</div>
                </div>`;
        }
    </script>
</body>
</html>
